<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <title>:FOCUS</title>
        <link rel="shortcut icon" href="favicon.png" />
        <link rel="stylesheet" href="css/client.css" />
    </head>

    <body data-url="http://localhost:3000/">

        <section id="front_section" data-position="current" data-order="0" >
            <form action="#" method="POST" id="login_form" onsubmit="return false;">
                <img src="img/logo-full.png" alt=":FOCUS" width="180" height="40" /><br />
                <input type="text" placeholder="Student Number" id="student_number_input" required="required" value="2010-43168" autofocus="true"/><br />
                <input type="text" placeholder="Username" id="username_input" required="required" value="ravenjohn" autofocus="true"/><br />
                <input type="password" placeholder="Password" id="password_input" required="required" value=""/>
                <button id="sign_in_button">Login via SystemOne</button>
            </form>
        </section>

        <section id="main_section" data-position="right">
            <div id="name_div">Student</div>
            <button id="logout_button"></button>
            <div id="chat_div">
                <ul id="chat_content"></ul>
            </div>
            <textarea id="chat_area"></textarea>
        </section>

        <script type="text/javascript" src="http://localhost:3000/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="js/Cookies.js"></script>
        <script type="text/javascript">
            (function(root){
                var url = document.body.attributes['data-url'].value,
                    chat_content = document.getElementById('chat_content'),
                    socket,
                    name;

                document.getElementById('sign_in_button').onclick = function () {
                    var self = this,
                        username = document.getElementById('username_input'),
                        student_number = document.getElementById('student_number_input'),
                        password = document.getElementById('password_input'),
                        request = new XMLHttpRequest();

                    student_number.disabled = password.disabled = username.disabled = 'disabled';

                    request.open('POST', url + 'student/login', true);
                    request.setRequestHeader('Content-Type', 'application/json');
                    request.send(JSON.stringify({
                        username : username.value,
                        student_number : student_number.value,
                        password : password.value
                    }));

                    request.onreadystatechange = function() {
                        var toTitleCase = function (str) {
                                return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                            },
                            response;
                        if (request.readyState + request.status == 204) {
                            response = JSON.parse(request.responseText);
                            if (response.message) {
                                self.innerHTML = 'Error!';
                                self.className = 'sign_in_error';
                                setTimeout(function () {
                                    self.className = '';
                                    self.innerHTML = 'Login via SystemOne';
                                    student_number.disabled = password.disabled = username.disabled = '';
                                    username.focus();
                                }, 1000);
                            }
                            else {
                                // set cookie, expire in 3 hours
                                Cookies.set('FOCUSSESSID', response.access_token, { expires: 60 * 60 * 3 });

                                socket = io.connect(url);
                                socket.on('start', function (data) {
                                    socket.emit('set_id', {id : Cookies.get('FOCUSSESSID')});
                                });
                                socket.on('chat', function (data) {
                                    chat_content.innerHTML += '<li class="incoming">' + data.message + '</li>';
                                });

                                document.getElementById('name_div').innerHTML = name = toTitleCase(response.first_name.split(" ")[0]) + " " + toTitleCase(response.last_name);
                                self.innerHTML = 'Login Success!';
                                self.className = 'sign_in_success';
                                setTimeout(function () {
                                    document.getElementById('front_section').className = 'current-to-left';
                                    document.getElementById('main_section').className = 'right-to-current';
                                    self.className = '';
                                    self.innerHTML = 'Login via SystemOne';
                                    student_number.disabled = student_number.value = password.value = username.value = password.disabled = username.disabled = '';
                                    chat_content.focus();
                                }, 250);
                            }
                        }
                    }
                };

                document.getElementById('logout_button').onclick = function () {
                    var request = new XMLHttpRequest();
                    request.open('POST', url + 'student/logout', true);
                    request.setRequestHeader('Content-Type', 'application/json');
                    request.send(JSON.stringify({
                        access_token : Cookies.get('FOCUSSESSID')
                    }));
                    Cookies.expire('FOCUSSESSID');
                    document.getElementById('front_section').className = 'left-to-current';
                    document.getElementById('main_section').className = 'current-to-right';
                    document.getElementById('username_input').focus();
                };

                document.getElementById('chat_area').onkeypress = function (e) {
                    if (e.ctrlKey && e.keyCode == 10) {
                        socket.emit('chat', {
                            id : Cookies.get('FOCUSSESSID'),
                            message : e.target.value
                        });
                        chat_content.innerHTML += '<li>' + e.target.value + '</li>';
                        e.target.value = '';
                        chat_content.scrollTop = chat_content.scrollHeight;
                    }
                };

                document.getElementById('username_input').focus();
            }(this));
        </script>

    </body>

</html>
