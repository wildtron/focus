<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <title>:FOCUS</title>
        <link rel="shortcut icon" href="favicon.png" />
        <link rel="stylesheet" href="css/client.css" />
    </head>

    <body data-url="http://10.0.5.49:3000/">

        <section id="front_section" data-position="current" data-order="0" >
            <form action="#" method="POST" id="login_form" onsubmit="return false;">
                <img src="img/logo-full.png" alt=":FOCUS" width="180" height="40" /><br />
                <input type="text" placeholder="Student Number" id="student_number_input" required="required" value="2010-41794" autofocus="true"/><br />
                <input type="text" placeholder="Username" id="username_input" required="required" value="wildtron" autofocus="true"/><br />
                <input type="password" placeholder="Password" id="password_input" required="required" value=""/>
                <button id="sign_in_button">Login via SystemOne</button>
            </form>
        </section>

        <section id="main_section" data-position="right">
            <div id="holder"></div>
            <div id="name_div"></div>
            <button id="logout_button"></button>
            <div id="chat_div">
                <ul id="chat_content">
                    <li class="incoming"><b>Welcome! </b><br />To send a message press Ctrl+Enter.<br />To send a file, drag and drop it on the text area below.</li>
                </ul>
            </div>
            <textarea id="chat_area"></textarea>
        </section>
        <script type="text/javascript" src="http://10.0.5.49:3000/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="js/cookies.js"></script>
        <script>
            if (typeof require !== '' + void 0) {
                var gui = require('nw.gui'),
                    win = gui.Window.get(),
                    ctrl = gui.Window;
                win.on('minimize', function(){
                    console.log("Window is minimized.");
                });

                win.on('close', function(){
                    console.log(this);
                    console.log(ctrl);
                    this.minimize();
                });
                win.on('closed', function(){
                    win = null;
                });

                // check session every 500ms, if not autofocus on window
                setInterval(function(){
                    if(!cookies.get('FOCUSSESSID')){
                        win.focus();
                    } else clearInterval(this);
                },500);
            }
        </script>
        <script type="text/javascript">
            (function(root){
                var url = document.body.attributes['data-url'].value,
                    chat_content = document.getElementById('chat_content'),
                    socket,
                    _student_number,
                    name,
                    temp,
                    username = document.getElementById('username_input'),
                    student_number = document.getElementById('student_number_input'),
                    password = document.getElementById('password_input');

                root.ondragover = function(e) { e.preventDefault(); return false };
                root.ondrop = function(e) { e.preventDefault(); return false };

                if(cookies.has('FOCUSSESSID')){
                    setTimeout(function () {
                        document.getElementById('front_section').className = 'current-to-left';
                        document.getElementById('main_section').className = 'right-to-current';
                        self.className = '';
                        self.innerHTML = 'Login via SystemOne';
                        student_number.disabled = student_number.value = password.value = username.value = password.disabled = username.disabled = '';
                        chat_content.focus();
                    }, 250);
                }
                document.getElementById('sign_in_button').onclick = function () {
                    var self = this,
                    request = new XMLHttpRequest();
                    student_number.disabled = password.disabled = username.disabled = 'disabled';

                    request.open('POST', url + 'student/login', true);
                    request.setRequestHeader('Content-Type', 'application/json');
                    request.send(JSON.stringify({
                        username : username.value,
                        student_number : student_number.value,
                        password : password.value
                    }));

                    request.onreadystatechange = function() {
                        var toTitleCase = function (str) {
                                return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                            },
                            response;

                        if (request.readyState + request.status == 204) {
                            response = JSON.parse(request.responseText);
                            if (response.message) {
                                self.innerHTML = 'Error!';
                                self.className = 'sign_in_error';
                                setTimeout(function () {
                                    self.className = '';
                                    self.innerHTML = 'Login via SystemOne';
                                    student_number.disabled = password.disabled = username.disabled = '';
                                    username.focus();
                                }, 1000);
                            }
                            else {
                                console.log('Authentication from server was success.');
                                // set cookie, expire in 3 hours
                                cookies.set('FOCUSSESSID', response.access_token, 10800);
                                cookies.set('first_name', response.first_name, 10800);
                                cookies.set('last_name', response.last_name, 10800);

                                _student_number = student_number.value;

                                // set 5 second interval on setting session

                                console.log('Creating socket to connect to server for chat');
                                socket = io.connect(url);
                                socket.emit('join_room', {student_number : _student_number});
                                socket.on('update_chat', function (message) {
                                    chat_content.innerHTML += '<li class="incoming">' + message + '</li>';
                                });


                                console.log('Setting environment for login');
                                document.getElementById('name_div').innerHTML = name = toTitleCase(cookies.get('first_name').split(" ")[0]) + " " + toTitleCase(cookies.get("last_name"));
                                self.innerHTML = 'Login Success!';
                                self.className = 'sign_in_success';

                                console.log('Moving sections');
                                setTimeout(function () {
                                    document.getElementById('front_section').className = 'current-to-left';
                                    document.getElementById('main_section').className = 'right-to-current';
                                    self.className = '';
                                    self.innerHTML = 'Login via SystemOne';
                                    student_number.disabled = student_number.value = password.value = username.value = password.disabled = username.disabled = '';
                                    chat_content.focus();
                                }, 250);

                                console.log('Sending setSession to localhost:8286 so that session is set as key for transanction');
                                setInterval(function(){
                                    var sessionServer='localhost:10610',
                                        setSessionRequest = new XMLHttpRequest();
                                    setSessionRequest.open('POST', sessionServer, true);
                                    setSessionRequest.setRequestHeader('Content-Type', 'application/json');
                                    setSessionRequest.send(JSON.stringify({
                                        session : cookies.get('FOCUSSESSID')
                                    }));
                                    if(setSessionRequest.readyState + setSessionRequest.status == 100){
                                        clearInterval(this);
                                    }
                                }, 5000);
                            }
                        }
                    }
                };

                document.getElementById('logout_button').onclick = function () {
                    var request = new XMLHttpRequest();
                    request.open('POST', url + 'student/logout', true);
                    request.setRequestHeader('Content-Type', 'application/json');
                    request.send(JSON.stringify({
                        access_token : cookies.get('FOCUSSESSID')
                    }));
                    cookies.remove('FOCUSSESSID');
                    cookies.remove('first_name');
                    cookies.remove('last_name');
                    document.getElementById('front_section').className = 'left-to-current';
                    document.getElementById('main_section').className = 'current-to-right';
                    document.getElementById('username_input').focus();
                };

                temp = document.getElementById('chat_area');
                temp.onkeypress = function (e) {
                    if (e.ctrlKey && e.keyCode == 10) {
                        socket.emit('update_chat', {
                            message : e.target.value,
                            student_number : _student_number
                        });
                        chat_content.innerHTML += '<li>' + e.target.value + '</li>';
                        e.target.value = '';
                        chat_content.scrollTop = chat_content.scrollHeight;
                    }
                };

                temp.ondragover = function () {
                    console.log('dragover');
                    this.value = 'Drag file here to upload';
                    this.className = 'hover';
                    return !1;
                };
                temp.ondragleave = function () {
                    this.value = this.className = '';
                    return !1;
                };

                temp.ondrop = function (e) {
                    var formData = new FormData(),
                        xhr = new XMLHttpRequest(),
                        _this = this,
                        i;

                    for (i = 0; i < e.dataTransfer.files.length; i++) {
                        formData.append('file', e.dataTransfer.files[i]);
                    }

                    console.log('drop');

                    e.preventDefault();
                    _this.value = 'Uploading...';
                    _this.className = 'uploading';
                    _this.disabled = true;


                    xhr.open('POST', url + 'student/submit', true);
                    xhr.onload = function () {
                        if (xhr.status === 200) {
                            setTimeout(function () {
                                _this.value = 'Success!';
                                _this.className += ' success';
                                setTimeout(function () {
                                    _this.disabled = false;
                                    _this.className = '';
                                    _this.value = '';
                                }, 500);
                            }, 1000);
                        } else {
                            console.log('Something went terribly wrong...');
                        }
                    };

                    xhr.send(formData);

                    return false;
                };

                document.getElementById('username_input').focus();
            }(this));
        </script>

    </body>

</html>
