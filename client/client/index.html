<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <title>:FOCUS</title>
        <link rel="shortcut icon" href="favicon.png" />
        <link rel="stylesheet" href="css/client.css" />
        <script src="js/config.js"></script>
    </head>
    <script type='text/javascript'>
        document.write('<body data-url="http://'+motherServer+':'+port+'/">');
    </script>
        <section id="front_section" data-position="current" data-order="0" >
            <form action="#" method="POST" id="login_form" onsubmit="return false;">
                <img src="img/logo-full.png" alt=":FOCUS" width="180" height="40" /><br />
                <input type="text" placeholder="Student Number" id="student_number_input" required="required" value="2010-41794" autofocus="true" pattern="(19|20)[0-9]{2}-[0-9]{5}" maxlength="10"/><br />
                <input type="text" placeholder="Username" id="username_input" required="required" value="wildtron" autofocus="true"/><br />
                <input type="password" placeholder="Password" id="password_input" required="required" value=""/>
                <button id="sign_in_button">Login via SystemOne</button>
            </form>
        </section>

        <section id="main_section" data-position="right">
            <div id="holder"></div>
            <div id="name_div"></div>
            <button id="logout_button"></button>
            <div id="chat_div">
                <ul id="chat_content">
                    <li class="incoming"><b>Welcome! </b><br />To send a message press Ctrl+Enter.<br />To send a file, drag and drop it on the text area below.</li>
                </ul>
            </div>
            <textarea id="chat_area"></textarea>
        </section>
        <script type="text/javascript">
            document.write('<script type="text/javascript" src="http://'+motherServer+':'+port+'/socket.io/socket.io.js"/><\/script>');
        </script>
        <script type="text/javascript" src="js/cookies.js"></script>
        <script>
            if (typeof require !== '' + void 0) {
                var gui = require('nw.gui'),
                    win = gui.Window.get(),
                    ctrl = gui.Window;
                win.on('minimize', function(){
                    console.log("Window is minimized.");
                });

                win.on('close', function(){
                    console.log(this);
                    console.log(ctrl);
                    this.minimize();
                });
                win.on('closed', function(){
                    win = null;
                });

                // check session every 500ms, if not autofocus on window
                setInterval(function(){
                    if(!cookies.get('FOCUSSESSID')){
                        win.focus();
                    } else clearInterval(this);
                },500);
            }
        </script>
        <script type="text/javascript">
            //(function(root){
            root = this;
                var url = document.body.attributes['data-url'].value,
                    chat_content = document.getElementById('chat_content'),
                    socket,
                    name,
                    temp,
                    username = document.getElementById('username_input'),
                    student_number = document.getElementById('student_number_input'),
                    password = document.getElementById('password_input'),
                    setSessionTimer, destroySessionTimer,
                    toTitleCase = function (str) {
                        return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                    },
                    connectSocket = function () {
                        socket = io.connect(url);
                        socket.emit('s_join_room', cookies.get('FOCUSSESSID'));
                        socket.on('update_chat', function (message) {
                            chat_content.innerHTML += '<li class="incoming">' + message + '</li>';
                            chat_content.parentElement.scrollTop = chat_content.parentElement.scrollHeight;
                        });
						socket.on('warning', function (message) {
							console.dir(message);
						});
                    };

                root.ondragover = function(e) { e.preventDefault(); return false };
                root.ondrop = function(e) { e.preventDefault(); return false };

                if(cookies.has('FOCUSSESSID')){
                /*
                 * This is not yet complete. When FOCUSSESSID exists, the client should check from the motherServer
                 * if it is a valid session. If it is not, the session is destroyed and the client is logged out
                 * But if it exists, the server renews the session so that it is updated
                 */
                    connectSocket();
                    setTimeout(function () {
                        document.getElementById('front_section').className = 'current-to-left';
                        document.getElementById('main_section').className = 'right-to-current';
                        document.getElementById('name_div').innerHTML = name = toTitleCase(cookies.get('first_name').split(" ")[0]) + " " + toTitleCase(cookies.get("last_name"));
                        self.className = '';
                        self.innerHTML = 'Login via SystemOne';
                        student_number.disabled = student_number.value = password.value = username.value = password.disabled = username.disabled = '';
                        document.getElementById('chat_area').focus();
                    }, 250);
                }

                document.getElementById('sign_in_button').onclick = function () {
                    var self = this,
                    request = new XMLHttpRequest();
                    if(username.value == '' || student_number.value == '' || password.value == '')
                        return;
                    student_number.disabled = password.disabled = username.disabled = 'disabled';
                    request.open('POST', url + 'student/login', true);
                    request.setRequestHeader('Content-Type', 'application/json');
                    request.send(JSON.stringify({
                        username : username.value,
                        student_number : student_number.value,
                        password : password.value
                    }));

                    request.onreadystatechange = function(event) {
                        // replaced request.responseText to xhr.responseText
                        // it looked like request.responseText resends the whole request just to get the response
                        var xhr = event.target,
                            response;

                        if (xhr.status == 401 && xhr.readyState == 4) {
                            self.innerHTML = 'Error!';
                            self.className = 'sign_in_error';
                            setTimeout(function () {
                                self.className = '';
                                self.innerHTML = 'Login via SystemOne';
                                student_number.disabled = password.disabled = username.disabled = '';
                                username.focus();
                            }, 2000);


                        } else if(xhr.status == 200 && xhr.readyState == 4) {
                            response = JSON.parse(xhr.responseText);
                            /*
                                * When the server authenticates the payload and it was successful,
                                * set cookies to the client
                                */
                            console.log('Authentication from server was success.');
                            // set cookie, expire in 3 hours
                            cookies.set('FOCUSSESSID', response.access_token, 10800);
                            cookies.set('first_name', response.first_name, 10800);
                            cookies.set('last_name', response.last_name, 10800);
                            cookies.set('student_number', student_number.value, 10800);

                            // set 5 second interval on setting session
                            connectSocket();

                            console.log('Setting environment for login');
                            document.getElementById('name_div').innerHTML = name = toTitleCase(cookies.get('first_name').split(" ")[0]) + " " + toTitleCase(cookies.get("last_name"));
                            self.innerHTML = 'Login Success!';
                            self.className = 'sign_in_success';

                            console.log('Moving sections');
                            setTimeout(function () {
                                document.getElementById('front_section').className = 'current-to-left';
                                document.getElementById('main_section').className = 'right-to-current';
                                self.className = '';
                                self.innerHTML = 'Login via SystemOne';
                                student_number.disabled = student_number.value = password.value = username.value = password.disabled = username.disabled = '';
                                document.getElementById('chat_area').focus();
                            }, 250);

                            /*
                            * Send the FOCUSSESSID to local server. Do this until local server sets the session
                            */
                            console.log('Sending setSession.');

                            var sessionServer='http://localhost:10610',
                                setSessionRequest = new XMLHttpRequest();
                            setSessionRequest.open('POST', sessionServer, true);
                            setSessionRequest.setRequestHeader('Content-Type', 'application/json');
                            setSessionRequest.send(JSON.stringify({
                                session : cookies.get('FOCUSSESSID')
                            }));

                            setSessionRequest.onreadystatechange = function(event){
                                var xhr = event.target;

                                if(xhr.status == 200 && xhr.readyState == 4)
                                    alert('Welcome!');
                                else if(xhr.status == 401 && xhr.readyState == 4){
                                    alert('Please re-login.');
                                    document.getElementById('logout_button').click;
                                }
                            }
                        }
                    }
                };

                document.getElementById('logout_button').onclick = function () {
                    var request = new XMLHttpRequest();
                    request.open('POST', url + 'student/logout', true);
                    request.setRequestHeader('Content-Type', 'application/json');
                    request.send(JSON.stringify({
                        access_token : cookies.get('FOCUSSESSID')
                    }));

                    cookies.remove('FOCUSSESSID');
                    cookies.remove('first_name');
                    cookies.remove('last_name');
                    cookies.remove('student_number')

                    var sessionServer='http://localhost:10610';
                    console.log('Destroy session to localhost:10610 so that controls are off');
                    setTimeoutTimer = setTimeout(function(){
                        console.log("Trying to destroy session to local server.");
                        var setSessionRequest = new XMLHttpRequest();
                        setSessionRequest.open('POST', sessionServer, true);
                        setSessionRequest.setRequestHeader('Content-Type', 'application/json');
                        setSessionRequest.send(JSON.stringify({
                            destroy : cookies.get('FOCUSSESSID')
                        }));

                        if(setSessionRequest.readyState == 200 &&  setSessionRequest.status == 4){
                            console.log('Session destroyed from local server');
                            clearTimeout(this);
                            clearInterval(setSessionTimer);
                        }
                    }, 5000);

                    document.getElementById('chat_div').innerHTML= "<ul id=\"chat_content\">" +
                                                           "     <li class=\"incoming\"><b>Welcome! </b><br />To send a message press Ctrl+Enter.<br />To send a file, drag and drop it on the text area below.</li>" +
                                                           "</ul>";
                    document.getElementById('front_section').className = 'left-to-current';
                    document.getElementById('main_section').className = 'current-to-right';
                    document.getElementById('username_input').focus();
                };

                temp = document.getElementById('chat_area');
                temp.onkeypress = function (e) {
                    if (e.ctrlKey && e.keyCode == 10) {
                        socket.emit('update_chat', {
                            message : e.target.value,
                            student_number : cookies.get('student_number')
                        });
                        chat_content.innerHTML += '<li>' + e.target.value + '</li>';
                        e.target.value = '';
                        chat_content.parentElement.scrollTop = chat_content.parentElement.scrollHeight
                    }
                };

				temp.ondragleave = temp.ondragend = function () {
					this.disabled = false;
					this.className = '';
					this.value = '';
				};

                temp.ondragstart = temp.ondragover = function () {
                    this.value = 'Drag file here to upload';
                    this.className = 'hover';
                    return !1;
                };

                temp.ondrop = function (e) {
                    var formData = new FormData(),
                        xhr = new XMLHttpRequest(),
                        _this = this,
                        files_count = e.dataTransfer.files.length,
                        i;
                    e.preventDefault();

                    if (!confirm('Are you sure you want to submit this file?')) return !1;

                    for (i = 0; i < files_count; i++) {
                        formData.append('file', e.dataTransfer.files[i]);
                    }

                    formData.append('access_token', cookies.get('FOCUSSESSID'));

                    _this.value = 'Uploading...';
                    _this.className = 'uploading';
                    _this.disabled = true;

                    xhr.open('POST', url + 'student/submit', true);
                    xhr.onload = function () {
                        if (xhr.status === 200) {
                            setTimeout(function () {
                                _this.value = 'Success!';
                                _this.className += ' success';
                                setTimeout(function () {
                                    _this.disabled = false;
                                    _this.className = '';
                                    _this.value = '';
                                    chat_content.innerHTML += '<li class="incoming">' + JSON.parse(xhr.responseText).message + '</li>';
                                    socket.emit('update_chat', {
                                        message : JSON.parse(xhr.responseText).message,
                                        student_number : cookies.get('student_number')
                                    });
                                    chat_content.parentElement.scrollTop = chat_content.parentElement.scrollHeight
                                }, 500);
                            }, 1000);
                        } else {
                            setTimeout(function () {
                                _this.value = 'Failed!';
                                _this.className += ' failed';
                                setTimeout(function () {
                                    _this.disabled = false;
                                    _this.className = '';
                                    _this.value = '';
                                    chat_content.innerHTML += '<li class="incoming">Failed to submit ' + files_count + ' file' + (files_count > 1 ? 's' : '') + '. Please try again.</li>';
                                }, 500);
                            }, 500);
                        }
                    };

                    xhr.send(formData);

                    return false;
                };

                document.getElementById('username_input').focus();
            //}(this));
        </script>
    </body>
</html>
