#!/usr/local/bin/node
var dbus = require('./index.js');
var memwatch = require('memwatch');
 
//require('v8-profiler');

var bus;
 
bus = dbus.sessionBus({socket: '/var/run/dbus/system_bus_socket'});
bus.connection.on('error',function(err){
  console.log("Error on dbus connection: " +JSON.stringify(err,null,2));
})


// do some things ...

// Take the second snapshot and compute the diff
 
function leak() {
  var hd = new memwatch.HeapDiff();
  /*
  bus.invoke({
    type: dbus.messageType.methodCall,
    path:'/org/freedesktop/UPower/devices/battery_BAT0',
    destination: 'org.freedesktop.UPower',
    interface: 'org.freedesktop.DBus.Introspectable',
    member: 'Introspect',
  }, function invokeCallback(err,res){
    if(err) {
      console.log("Error invoking:" + err);
    }
  });
  */
  bus.listNames(function() {
    leak(); 
    var diff = hd.end();
    console.log(diff);
    debugger;
  });
};
 
memwatch.on('leak', function memwatchLeak(info) { 
  console.log('*********************** LEAK *****:'+JSON.stringify(info));
});
 
leak();

//var agent = require('webkit-devtools-agent');

//setInterval(leak,10);
